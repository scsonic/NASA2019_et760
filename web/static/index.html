<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Honeycomb System by ET760</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


    <style>

        html, body {
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
        }
        #map {
          height: 100%;
          width: 100%;
        }

        div.navi {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 60px;
            background-color :  rgba(200,200,200,0.6)
        }

        #legend {
            padding: 5px ;
            background-color :  rgba(200,200,200,0.6)
        }
        #legend span{
            margin-top: 3px;
            width: 100%;
            float:left ;
            text-align: left;
        }

        #legend span img {
            margin-right: 5px;
        }

        div.navi {
            padding: 1em;
            float: left  ;
        }
        div.navi_left {
            float:right  ;
        }

        div.navi span.title {
            text-size: 10em ;
        }

        div.callforhelp {
            width: 470px;
        }
        div.callforhelp img{
            width: 400px ;
        }
    </style>
</head>
<body>
    <div class=navi>
        <span class="title"></span>

        <div class="navi_left">
<!--                 <button type="button" class="btn btn-light" id="joinDrone">
                    Join FireFighter
                </button> -->

                <button type="button" class="btn btn-light" data-toggle="modal" data-target="#exampleModalLong">
                    Drone List
                </button>

            <div class="btn btn-light">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="swArea" checked>
                    <label class="custom-control-label" for="swArea">Warning Area</label>
                </div>
            </div>
        </div>

    </div>
    <div id="map"></div>
    <div id="legend">
        <span class="btn btn-light btn-sm"><img width=48 height=26 src="img/fire48.png"/>Wildfire</span><BR>        
        <span class="btn btn-light btn-xs"><img width=48 height=26 src="img/green_circle48.png"/>Manual</span><BR>
        <span class="btn btn-light"><img width=48 height=26  src="img/drone_yellow48.png"/>FireBee Patrol</span><BR>
        <span class="btn btn-light"><img width=48 height=26 src="img/drone_black64.png"/>FireBee FireFighter</span><BR>
        <span class="btn btn-light"><img width=48 height=26   src="img/drone_gray48.png"/>Return To Home</span><BR>
        <span class="btn btn-light"><img width=48 height=26  src="img/yellow48.png"/>Danger Area</span><BR>
        <span class="btn btn-light"><img width=48 height=26   src="img/red48.png"/>Warning Area</span>

        <!--
        <span class="btn btn-light"><img width=25 height=25 src="https://maps.google.com/mapfiles/kml/shapes/info-i_maps.png"/>Info</span>
     -->
    </div>

<div class="modal fade" id="CallForHelp" tabindex="-1" role="dialog" aria-labelledby="CallForHelpTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="CallForHelpTitle">Call For Help</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <!-- ===================================== -->
        <div class="callforhelp">
            <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
              <ol class="carousel-indicators">
                <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
              </ol>
              <div class="carousel-inner">
                <div class="carousel-item active">
                  <img src="img/001.png" class="d-block w-100" alt="...">
                </div>
                <div class="carousel-item">
                  <img src="img/003.png" class="d-block w-100" alt="...">
                </div>
                <div class="carousel-item">
                  <img src="img/004.png" class="d-block w-100" alt="...">
                </div>
              </div>
              <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
              </a>
              <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
              </a>
            </div>
                    
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-info" data-dismiss="modal" id="callDrone">Send Message</button>
                  </div>
                </div>
              </div>
            </div>

        </div>
        
        <!-- ===================================== -->

    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Fire Bee List</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Owner</th>
              <th scope="col">Power</th>
              <th scope="col">Retardant</th>
              <th scope="col">State</th>
            </tr>
          </thead>
          <tbody id="trList">
            <tr>
              <th scope="row">1</th>
              <td>Bob</td>
              <td>60%</td>
              <td>80%</td>
              <td>FireFighter</td>
            </tr>
            <tr>
              <th scope="row">2</th>
              <td>Pixhawk</td>
              <td>85%</td>
              <td>0%</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">3</th>
              <td>Larry</td>
              <td>15%</td>
              <td>0%</td>
              <td>Return To Home</td>
            </tr>
            <tr>
              <th scope="row">4</th>
              <td>Jack</td>
              <td>41%</td>
              <td>60%</td>
              <td>FireFighter</td>
            </tr>
            <tr>
              <th scope="row">5</th>
              <td>Gov</td>
              <td>45%</td>
              <td>--</td>
              <td>Guide</td>
            </tr>
            <tr>
              <th scope="row">6</th>
              <td>pika</td>
              <td>99%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">7</th>
              <td>BuBuBu</td>
              <td>95%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">7</th>
              <td>BuBuBu</td>
              <td>95%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">8</th>
              <td>Gov </td>
              <td>95%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">9</th>
              <td>Gov </td>
              <td>95%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">10</th>
              <td>Gov </td>
              <td>90%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">11</th>
              <td>Gov </td>
              <td>55%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">12</th>
              <td>Pikachu </td>
              <td>15%</td>
              <td>0%</td>
              <td>Return To Home</td>
            </tr>
            <tr>
              <th scope="row">13</th>
              <td>Harry</td>
              <td>14%</td>
              <td>0%</td>
              <td>Return To Home</td>
            </tr>
            <tr>
              <th scope="row">14</th>
              <td>Sysu</td>
              <td>120%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">15</th>
              <td>YouGangKuo</td>
              <td>120%</td>
              <td>100%</td>
              <td>FireFighter</td>
            </tr>
            <tr>
              <th scope="row">16</th>
              <td>WeiHan</td>
              <td>120%</td>
              <td>100%</td>
              <td>FireFighter</td>
            </tr>
            <tr>
              <th scope="row">17</th>
              <td>Vincent</td>
              <td>120%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
            <tr>
              <th scope="row">18</th>
              <td>ET760</td>
              <td>120%</td>
              <td>--</td>
              <td>Patrol</td>
            </tr>
          </tbody>
        </table>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-info" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

    <script>

        //var url_base = "https://scsonic.github.io/NASA2019_et760/web/static/" ;
        var base_url = '' ;

        var videoIndex = 0 ;

        var map; // global google map !! 
          
        var gLat = 24.04023 ;
        var gLon =  120.56805 ;
        var position = [gLat, gLon] ;

        var fireList = [] ;
        var droneList = [] ;

        var areaInfoWindow ;
        var bermudaTriangle ;
        var yellowTriangle ; 

        $('#swArea').change(function() {
            //console.log("ret=" + $(this).is(':checked')) ;
            var isCheck = $(this).is(':checked') ;
            if (isCheck) {
                bermudaTriangle.setMap(map);    
                yellowTriangle.setMap(map) ;
            }
            else {
                bermudaTriangle.setMap(null);
                yellowTriangle.setMap(null) ;
            }
        });

        function getRnd(x){
            var t = Math.floor(Math.random()*x) ;
            t = t - x / 2;
            t = t * 0.0005 ; ;
            return t ;
        };

        function getRndTiny(x){
            var t = Math.floor(Math.random()*x) ;
            t = t - x / 2;
            t = t * 0.0001 ; ;
            return t ;
        };


        function getIntRnd(x){
            return Math.floor(Math.random()*x)
        };

        var yellowCoords = [
                {lat: 24.039066456936286, lng: 120.56802317790982 }, 
                {lat: 24.038997868805684, lng: 120.5684523313522 }, 
                {lat: 24.039301615963197, lng: 120.56902095966336 }, 
                {lat: 24.03954657282509, lng: 120.56934282474515 }, 
                {lat: 24.03986991516752, lng: 120.56977197818753 }, 
                {lat: 24.040418615461764, lng: 120.57021186046597 }, 
                {lat: 24.040928120779043, lng: 120.57051226787564 }, 
                {lat: 24.041506210903034, lng: 120.57071611576077 }, 
                {lat: 24.041868740670235, lng: 120.57110235385892 }, 
                {lat: 24.042339048032563, lng: 120.57099506549832 }, 
                {lat: 24.04229005776268, lng: 120.57038352184293 }, 
                {lat: 24.042407634379018, lng: 120.5699114530563 }, 
                {lat: 24.042407634379018, lng: 120.56957885913846 }, 
                {lat: 24.042407634379018, lng: 120.5690638750076 }, 
                {lat: 24.042201875229775, lng: 120.56887075595853 }, 
                {lat: 24.04193732726784, lng: 120.56838795833585 }, 
                {lat: 24.042025509982377, lng: 120.56796953372952 }, 
                {lat: 24.041868740670235, lng: 120.5676047533035 }, 
                {lat: 24.041721769266324, lng: 120.56750819377896 }, 
                {lat: 24.04144742219571, lng: 120.56736871891019 }, 
                {lat: 24.041251459643625, lng: 120.56714341335294 }, 
                {lat: 24.040996707878946, lng: 120.56711122684476 }, 
                {lat: 24.040526395601283, lng: 120.5671004980087 }, 
                {lat: 24.040193256695996, lng: 120.56725070171353 }, 
                {lat: 24.039997292230453, lng: 120.56728288822171 }, 
                {lat: 24.039732739727707, lng: 120.56727215938565 }, 
                {lat: 24.039477984950853, lng: 120.56737944774625 }, 
                {lat: 24.039380002209835, lng: 120.56752965145108 }, 
                {lat: 24.039272221108373, lng: 120.56770131282804 }
            ];

            var triangleCoords = [
                {lat: 24.039482884085942, lng: 120.56803927116391 }, 
                {lat: 24.039600463272016, lng: 120.56826994113919 }, 
                {lat: 24.0397670336014, lng: 120.56851133995053 }, 
                {lat: 24.039909108123414, lng: 120.56877956085202 }, 
                {lat: 24.04010997183467, lng: 120.56906923942563 }, 
                {lat: 24.040315734335145, lng: 120.56924626522061 }, 
                {lat: 24.040658671103436, lng: 120.56932673149106 }, 
                {lat: 24.040942818017815, lng: 120.5691175191879 }, 
                {lat: 24.041153478255463, lng: 120.56876346759793 }, 
                {lat: 24.041251459643625, lng: 120.56829139881131 }, 
                {lat: 24.0412808540455, lng: 120.56804463558194 }, 
                {lat: 24.041065294942218, lng: 120.56753501586911 }, 
                {lat: 24.04094771709704, lng: 120.56749210052487 }, 
                {lat: 24.040756652869053, lng: 120.56736335449216 }, 
                {lat: 24.04055089107492, lng: 120.56737408332822 }, 
                {lat: 24.040472505542834, lng: 120.5674599140167 }, 
                {lat: 24.040183458479824, lng: 120.56758866004941 }, 
                {lat: 24.039962998418247, lng: 120.56763157539365 }, 
                {lat: 24.03974743710327, lng: 120.5677120416641 }, 
                {lat: 24.039566169353872, lng: 120.56776568584439 }, 
                {lat: 24.03954167369243, lng: 120.56787297420499 }
            ];



        function initMap() {
            console.log("init map start") ;
            var latlng = new google.maps.LatLng(gLat, gLon);
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: gLat, lng: gLon },
                zoom: 17,
                mapTypeId: 'satellite',
                mapTypeControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.LEFT_CENTER
                },
                scaleControl: true,
                streetViewControl: false,
           });

                    // Define the LatLng coordinates for the polygon.
            
            // Construct the polygon.
            bermudaTriangle = new google.maps.Polygon({
              paths: triangleCoords,
              strokeColor: '#FF0000',
              strokeOpacity: 0.8,
              strokeWeight: 3,
              fillColor: '#FF0000',
              fillOpacity: 0.35
            });
            bermudaTriangle.setMap(map);

            

            // Construct the polygon.
            yellowTriangle = new google.maps.Polygon({
              paths: yellowCoords,
              strokeColor: '#FFFF00',
              strokeOpacity: 0.8,
              strokeWeight: 3,
              fillColor: '#FFFF00',
              fillOpacity: 0.35
            });
            yellowTriangle.setMap(map);



            /** @this {google.maps.Polygon} */
            function showArrays(event) {
                console.log("{lat: " + event.latLng.lat() + ", lng: " + event.latLng.lng() + " }")
                var contentString = '<b>Bermuda Triangle polygon</b><br>' +
                    'Clicked location: <br>' 

                // Replace the info window's content and position.
                areaInfoWindow.setContent(contentString);
                areaInfoWindow.setPosition(event.latLng);
                areaInfoWindow.open(map);
            }



            // Add a listener for the click event.
            bermudaTriangle.addListener('click', showArrays);
            areaInfoWindow = new google.maps.InfoWindow;


            function displayVideo(result) {
                videoIndex = videoIndex + 1 ;
                var infoPos = {
                      lat: gLat + 0.002,
                      lng: gLon + 0.005 
                    };

                  var infowindow = new google.maps.InfoWindow({
                    content: '<iframe width="400" height="300" src="https://www.youtube.com/embed/_EF5AyzgFLE?s=30&autoplay=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',
                    position: infoPos,
                    maxWidth: 400,
                    maxHeight: 300,
                    pixelOffset: new google.maps.Size(100, -20) 
                  });
                  infowindow.open(map);

            }


            // ============ INIT FIRE POSITION
            var fireCount = 5;
            for (var i = 0 ; i < fireCount ; i = i + 1 ) {
                var fire = new google.maps.Marker({
                    position: new google.maps.LatLng(gLat+getRndTiny(3), gLon+getRndTiny(3) ),
                    map: map,
                    zIndex:-100,
                    icon: base_url + 'img/fire32.png'
                });
                console.log("push one fire") ;
                fireList.push(fire) ;
            }

            var droneCount = 6 ;


            for ( var d = 0 ; d < droneCount ; d = d + 1) {
                var usingIcon = 'img/drone_black64.png' ;

                var drone = new google.maps.Marker({
                    position: new google.maps.LatLng(gLat+getRndTiny(5), gLon+getRndTiny(5) ),
                    map: map,
                    icon: usingIcon
                });
                drone.posX = gLat+getRndTiny(30) ;
                drone.posY = gLon+getRndTiny(30) ;

                drone._id = "d" + d ;
                drone._numDeltas = 80 + getIntRnd(20) ;
                drone._delay = 50 + getIntRnd(10); //milliseconds
                drone._cnt = 0 ;
                drone._deltaLat = 0.0 ;
                drone._deltaLng = 0.0 ;

                drone._startX = gLat+getRndTiny(1) ;
                drone._startY = gLon+getRndTiny(1) ;
                drone._endX = gLat+getRndTiny(100) ;
                drone._endY = gLon+getRndTiny(100) ;
                drone._dir = 1 ;

                console.log("push one drone") ;
                droneList.push(drone) ;
                //transitionV2(drone, [gLat+getRnd(200), gLon+getRnd(200)]);

                droneList[ droneList.length -1 ].addListener('click',function(target){
                    console.log(target) ;
                    console.log("get done id=" + target ) ;
                    displayVideo() ;
                });
            }



            var gCenter = new google.maps.LatLng(24.930000, 121.280000) ;

            // // Create markers.
            // features.forEach(function (feature) {
            //     var marker = new google.maps.Marker({
            //         position: feature.position,
            //         icon: icons[feature.type].icon,
            //         map: map
            //     });
            // });


            var numDeltas = 20;
            var delay = 100 + Math.random(40) ; //milliseconds
            var i = 0;
            var deltaLat;
            var deltaLng;

            function transitionV2(drone, result){
                drone._cnt = 0;
                //drone.posX = result[0] ;
                //drone.posY = result[1] ;
                drone._deltaLat = (result[0] - drone.posX)/drone._numDeltas;
                drone._deltaLng = (result[1] - drone.posY)/drone._numDeltas;
                moveMarkerV2(drone);
            }

            function moveMarkerV2(drone){
                drone.posX += drone._deltaLat;
                drone.posY += drone._deltaLng;

                var latlng = new google.maps.LatLng(drone.posX, drone.posY);
                drone.setPosition(latlng);

                //console.log( drone._id + " cnt=" +  drone._cnt)
                if(drone._cnt != drone._numDeltas){
                    drone._cnt++ ;
                    setTimeout(function(){
                        moveMarkerV2(drone) ;
                    }, drone._delay);
                }
                else {
                    //console.log("change dir!! cnt=" + drone._cnt + "," + drone.posX + "/" + drone.posY) ;

                    drone._cnt = 0 ;
                    drone._deltaLat = 0.0 ;
                    drone._deltaLng = 0.0 ;
                    if ( drone._dir == 1 ) {
                        drone._dir = 2 ;
                        drone.posX = drone._endX ;
                        drone.posY = drone._endY ;
                        transitionV2(drone, [drone._startX, drone._startY]) ;    
                        drone.setIcon('img/drone_black64.png') ;
                    } else if (drone._dir == 2) {
                        drone._dir = 1
                        drone.posX = drone._startX ;
                        drone.posY = drone._startY ;
                        transitionV2(drone, [drone._endX, drone._endY]) ; 
                        drone.setIcon('img/drone_gray48.png') ;
                    }
                    else if ( drone_dir == 3 ) {

                    }
                    //console.log("drone END!!") ;
                }
            }




            // ==========================


            var legend = document.getElementById('legend');
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);


            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                icon: 'img/drone_select48.png',
                title: "State: AirDrop<BR>Power: 50%<BR>Owner: Harry Poter"
            });

            function transition(result){
                i = 0;
                deltaLat = (result[0] - position[0])/numDeltas;
                deltaLng = (result[1] - position[1])/numDeltas;
                moveMarker();
            }


            function moveMarker(){
                position[0] += deltaLat;
                position[1] += deltaLng;
                var latlng = new google.maps.LatLng(position[0], position[1]);
                marker.setTitle("Latitude:"+position[0]+" | Longitude:"+position[1]);
                marker.setPosition(latlng);
                if(i!=numDeltas){
                    i++;
                    setTimeout(moveMarker, delay);
                }
            }

            google.maps.event.addListener(map, 'click', function(event) {
                var result = [event.latLng.lat(), event.latLng.lng()];
                transition(result);
            });

            for (var d = 0 ; d < droneList.length ; d=d+1) {
                var drone = droneList[d] ;
                transitionV2(drone, [drone._endX, drone._endY]) ; 
            }



            // ===================================

            initPatrol() ;
            initStopExit() ;
            $("#joinDrone").bind("click", function(){
                console.log("Call one") ;
                createCurrentDrone() ;
            }) ;


            var createLoop = function() {
                console.log("join one FireBee") ;
                createCurrentDrone() ;
                //setTimeout(createLoop, 3000) ;
            } ;

            setTimeout(createLoop, 3000) ;

            console.log("end of InitMap()") ;
        }
    </script>
    <script src="main.js">
        
    </script>
    <script>

    var API_URL = "https://firms.modaps.eosdis.nasa.gov/" ;
    var API_KEY = "" ;
    var PROXY_URL = "https://scsonic.com:5000/" ;
    var firms_csv = "fire_archive_V1_82135.csv" ;

    function recentWarning(callback) {
        $.ajax(PROXY_URL, function() {
            callback() ;
        }) ;
    }

function initPatrol() {
    console.log("initPatrol !!") ;
    var patrolCount = 5 ;

    for ( var d = 0 ; d < patrolCount ; d = d + 1) {
        var usingIcon = 'img/drone_yellow48.png' 

        var drone = new google.maps.Marker({
            position: new google.maps.LatLng(gLat+getRndTiny(5), gLon+getRndTiny(5) ),
            map: map,
            icon: usingIcon
        });
        drone.posX = gLat+getRndTiny(30) ;
        drone.posY = gLon+getRndTiny(30) ;


        var dis = 0.0009 ;
        // if ( d == 4  || d == 3) {
        //     dis = dis + 0.0004 ;
        // }
        var d2 = dis / 2 ;

        drone.pList = [] ;
        drone.pList.push( [gLat - d2  , gLon + dis  ] ) ;
        drone.pList.push( [gLat - dis , gLon + 0    ] ) ;
        drone.pList.push( [gLat - d2  , gLon - dis  ] ) ;
        drone.pList.push( [gLat + d2  , gLon - dis  ] ) ;
        drone.pList.push( [gLat + dis , gLon + 0    ] ) ;
        drone.pList.push( [gLat + d2  , gLon + dis  ] ) ;

        drone._id = "p" + d ;
        drone._numDeltas = 60 ;
        drone._delay = 40 + getIntRnd(5); //milliseconds
        drone._cnt = 0 ;
        drone._deltaLat = 0.0 ;
        drone._deltaLng = 0.0 ;

        drone._dir = 0;
        if ( d < 2 ) {
            drone._numDeltas = drone._numDeltas ;
            drone._dir = d * 3;
        }

        if ( d >=2 && d <=4) {
            drone.pList = []
            for (var i = 0 ; i < yellowCoords.length ; i++ ) {
                drone.pList.push( [yellowCoords[i].lat, yellowCoords[i].lng] ) ;
            }
            console.log("no > 5 =", drone.pList ) ;
            //drone.setIcon('img/blade48blue.png') ;
            drone._numDeltas = 20 ;
            drone._dir = Math.floor(( d-2 ) * (yellowCoords.length / 3)); 
        }
        console.log("get dir=" + drone._dir ) ;

        
        drone._startX = drone.pList[ drone._dir ][0] ;
        drone._startY = drone.pList[ drone._dir ][1] ;
        drone.setPosition(new google.maps.LatLng(drone._startX,drone._startY))  ;

        var nextDir = (drone._dir + 1) % drone.pList.length
        drone._endX = drone.pList[ drone._dir ][0] ;
        drone._endY = drone.pList[ drone._dir ][1] ;

        drone.transitionV3 = function(drone, result){
            drone._cnt = 0;
            //drone.posX = result[0] ;
            //drone.posY = result[1] ;
            drone._deltaLat = (result[0] - drone.posX)/drone._numDeltas;
            drone._deltaLng = (result[1] - drone.posY)/drone._numDeltas;
            drone.moveMarkerV3(drone);
        }

        drone.moveMarkerV3 = function(drone){
            drone.posX += drone._deltaLat;
            drone.posY += drone._deltaLng;

            var latlng = new google.maps.LatLng(drone.posX, drone.posY);
            drone.setPosition(latlng);

            //console.log( drone._id + " cnt=" +  drone._cnt)
            if(drone._cnt != drone._numDeltas){
                drone._cnt++ ;
                setTimeout(function(){
                    drone.moveMarkerV3(drone) ;
                }, drone._delay);
            }
            else {
                //console.log("change dir!! cnt=" + drone._cnt + "," + drone.posX + "/" + drone.posY) ;
                drone._cnt = 0 ;
                drone._deltaLat = 0.0 ;
                drone._deltaLng = 0.0 ;
                //console.log("p-drone " + drone._id + " dir=" + drone._dir) ;
                drone.posX = drone.pList[drone._dir][0] ;
                drone.posY = drone.pList[drone._dir][1] ;
                drone._dir = (drone._dir + 1) % drone.pList.length ;
                drone._startX = drone.pList[drone._dir][0] ;
                drone._startY = drone.pList[drone._dir][1] ;
                drone.transitionV3(drone, [drone._startX, drone._startY]) ;    
                drone.setIcon('img/drone_yellow48.png') ;
            }
        }
        drone.transitionV3( drone, drone.pList[ drone._dir ] )

        console.log("push one p-drone") ;
    }
}


var stop1 ;
var stop2 ;
var exit1 ;
var exit2 ;
var signToggle = false ;


// {lat: , lng:  }, 
// {lat: 24.041298000776816, lng: 120.56508079462048 }, 
// {lat: 24.041944675829697, lng: 120.57344928674695 }, 

function initStopExit() {
    var stop1 = new google.maps.Marker({
        position: new google.maps.LatLng(24.037334595426287, 120.56487067748446),
        map: map,
        icon: 'img/drone_stop.png'
    });
    var stop2 = new google.maps.Marker({
        position: new google.maps.LatLng(24.04381632957585, 120.56718541101759),
        map: map,
        icon: 'img/drone_stop.png'
    });

    var exit1 = new google.maps.Marker({
        position: new google.maps.LatLng(24.038319334254616, 120.56673303537366),
        map: map,
        icon: 'img/drone_exit.png'
    });


    var exit2 = new google.maps.Marker({
        position: new google.maps.LatLng(24.041572348166593, 120.56638434820172),
        map: map,
        icon: 'img/drone_exit.png'
    });
    var changeStopExit = function() {
        signToggle = ! signToggle; 
        if ( signToggle ) {
            stop1.setIcon('img/drone_stop.png') ;
            stop2.setIcon('img/drone_stop.png') ;
            exit1.setIcon('img/drone_exit.png') ;
            exit2.setIcon('img/drone_exit.png') ;
        }
        else {
            stop1.setIcon('img/drone_stop_darker.png') ;
            stop2.setIcon('img/drone_stop_darker.png') ;
            exit1.setIcon('img/drone_exit_darker.png') ;
            exit2.setIcon('img/drone_exit_darker.png') ;
        }

        setTimeout(changeStopExit, 500) ;
    }

    setTimeout(changeStopExit, 500) ;
}
    

    var rndNeg = function() {
        var rr = getIntRnd(2) ;
        if ( rr == 0 ) {
            return 1.0;
        }
        else if ( rr == 1 ) {
            return -1.0;
        }
        else if ( rr == 0 ) {
            return 1.0 ;
        }
    }


    var createCurrentDrone = function() {

        console.log("push current drone") ;

        var dis = 0.0009 ;
        var d2 = dis / 2 ;

        var pList = [] ;
        pList.push( [gLat + (0.0040 + getRndTiny(10) ) * rndNeg(), gLon + (0.0040 + getRndTiny(10) ) * rndNeg()  ] ) ;
        //pList.push( [gLat + 0.0040 , gLon + 0.0040 ] ) ;
        pList.push( [gLat - d2  , gLon + dis  ] ) ;
        pList.push( [gLat - dis , gLon + 0    ] ) ;
        pList.push( [gLat - d2  , gLon - dis  ] ) ;
        pList.push( [gLat + d2  , gLon - dis  ] ) ;
        pList.push( [gLat + dis , gLon + 0    ] ) ;
        pList.push( [gLat + d2  , gLon + dis  ] ) ;

        pList.push( pList[0] ) ;
        pList.push( pList[0] ) ;


        var usingIcon = 'img/drone_yellow64.png' 
        var drone = new google.maps.Marker({
            position: new google.maps.LatLng( pList[0][0], pList[0][1]),
            map: map,
            icon: usingIcon
        });
        drone.posX = pList[0][0] ;
        drone.posY = pList[0][1] ;


        drone.pList = pList ;

        

        drone._id = "currentDrone"
        drone._numDeltas = 30 ;
        drone._delay = 40; //milliseconds
        drone._cnt = 0 ;
        drone._deltaLat = 0.0 ;
        drone._deltaLng = 0.0 ;

        drone._dir = 0;
        
        drone._startX = drone.pList[ drone._dir ][0] ;
        drone._startY = drone.pList[ drone._dir ][1] ;
        drone.setPosition(new google.maps.LatLng(drone._startX,drone._startY))  ;

        var nextDir = (drone._dir + 1) % drone.pList.length
        drone._endX = drone.pList[ nextDir ][0] ;
        drone._endY = drone.pList[ nextDir ][1] ;

        drone.transitionV4 = function(drone, result){
            console.log("trans v4") ;
            drone._cnt = 0;
            //drone.posX = result[0] ;
            //drone.posY = result[1] ;
            drone._deltaLat = (result[0] - drone.posX)/drone._numDeltas;
            drone._deltaLng = (result[1] - drone.posY)/drone._numDeltas;
            drone.moveMarkerV4(drone);
        }

        drone.moveMarkerV4 = function(drone){
            console.log("move marker v4") ;

            drone.posX += drone._deltaLat;
            drone.posY += drone._deltaLng;

            var latlng = new google.maps.LatLng(drone.posX, drone.posY);
            drone.setPosition(latlng);

            //console.log( drone._id + " cnt=" +  drone._cnt)
            if(drone._cnt != drone._numDeltas){
                drone._cnt++ ;
                setTimeout(function(){
                    drone.moveMarkerV4(drone) ;
                }, drone._delay);
            }
            else {
                //console.log("change dir!! cnt=" + drone._cnt + "," + drone.posX + "/" + drone.posY) ;
                drone._cnt = 0 ;
                drone._deltaLat = 0.0 ;
                drone._deltaLng = 0.0 ;
                //console.log("p-drone " + drone._id + " dir=" + drone._dir) ;
                drone.posX = drone.pList[drone._dir][0] ;
                drone.posY = drone.pList[drone._dir][1] ;
                drone._dir = drone._dir + 1 ;

                if ( drone._dir >= drone.pList.length) {
                    console.log("current drone END!!!") ;
                    drone.setMap(null) ;
                    createCurrentDrone() ;
                }
                else {
                    drone._startX = drone.pList[drone._dir][0] ;
                    drone._startY = drone.pList[drone._dir][1] ;
                    drone.transitionV4(drone, [drone._startX, drone._startY]) ;    
                    drone.setIcon('img/drone_yellow64.png') ;
                }
            }
        }
        drone.transitionV4( drone, drone.pList[ drone._dir ] )

        console.log("push current drone... END") ;
    }


    </script>
        <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkI0UQK6hLzN3w4NKI7PAmgUR9TMKD9C0&callback=initMap"></script>

</body>
</html>