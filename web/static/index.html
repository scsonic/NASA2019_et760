<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Honeycomb System by ET760</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>


    <style>

        html, body {
          height: 100%;
          width: 100%;
          margin: 0;
          padding: 0;
        }
        #map {
          height: 100%;
          width: 100%;
        }

        div.navi {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 60px;
            background-color :  rgba(200,200,200,0.6)
        }

        #legend {
            padding: 5px ;

            background-color :  rgba(200,200,200,0.6)
        }
        #legend span{
            margin: 5px;
        }

        #dronelist {
            overflow-y: scroll;
            width: 400px;
            height: 200px;
            position: fixed;
            bottom: 0;
            left: 0;
            padding: 5px;
            background-color :  rgba(200,200,200,0.6)

        }
    </style>
</head>
<body>
    <div class=navi>
        <H2> Honeycomb System by ET760 </H2>
    </div>
    <div id="map"></div>
    <div id="legend">
        <span class="btn btn-light"><img width=25 height=25 src="img/fire.png"/>Wildfire</span>
        <span class="btn btn-light"><img width=25 height=25 src="img/blade48blue.png"/>ET760 Select Drone</span>
        <span class="btn btn-light"><img width=25 height=25 src="img/blade32green2.png"/>Active Drone</span>
        <span class="btn btn-light"><img width=25 height=25 src="img/blade32coffee.png"/>Home Drone</span>
        <span class="btn btn-light"><img width=25 height=25 src="https://maps.google.com/mapfiles/kml/shapes/info-i_maps.png"/>Info</span>
    </div>

    <div id="dronelist">
        <table class="table table-striped">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">UserName</th>
              <th scope="col">Power </th>
              <th scope="col">State</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th scope="row">1</th>
              <td>Bob's Drone</td>
              <td>60%</td>
              <td>Air Drop</td>
            </tr>
            <tr>
              <th scope="row">2</th>
              <td>Pixhawk</td>
              <td>85%</td>
              <td>Monitor</td>
            </tr>
            <tr>
              <th scope="row">3</th>
              <td>Larry</td>
              <td>30%</td>
              <td>Home</td>
            </tr>
            <tr>
              <th scope="row">4</th>
              <td>Jack</td>
              <td>41%</td>
              <td>Air Drop</td>
            </tr>
            <tr>
              <th scope="row">5</th>
              <td>NightHawk</td>
              <td>90%</td>
              <td>Monitor</td>
            </tr>
            <tr>
              <th scope="row">6</th>
              <td>pika</td>
              <td>99%</td>
              <td>Monitor</td>
            </tr>
            <tr>
              <th scope="row">7</th>
              <td>BuBuBu</td>
              <td>95%</td>
              <td>Air Drop</td>
            </tr>
          </tbody>
        </table>
    </div>
    <script>
        var videoIndex = 0 ;

        var gLat = 25.16593200;
        var gLon = 121.57407800;
        var position = [gLat, gLon] ;

        var fireList = [] ;
        var droneList = [] ;

        function getRnd(x){
            var t = Math.floor(Math.random()*x) ;
            t = t - x / 2;
            t = t * 0.0005 ; ;

            return t ;
        };

        function getIntRnd(x){
            return Math.floor(Math.random()*x)
        };

        function initMap() {
            console.log("init map start") ;
            var latlng = new google.maps.LatLng(gLat, gLon);
            var map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 25.16593200, lng:  121.57407800 },
                zoom: 15,
                mapTypeId: 'satellite',
                mapTypeControl: false,
                zoomControl: true,
                zoomControlOptions: {
                    position: google.maps.ControlPosition.LEFT_CENTER
                },
                scaleControl: true,
                streetViewControl: false,
           });

            function displayVideo(result) {
                videoIndex = videoIndex + 1 ;
                var infoPos = {
                      lat: gLat - 0.001,
                      lng: gLon + 0.01 
                    };

                  var infowindow = new google.maps.InfoWindow({
                    content: '<iframe width="400" height="300" src="https://www.youtube.com/embed/y-988C2elwU?s=30&autoplay=1" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>',
                    position: infoPos,
                    maxWidth: 400,
                    maxHeight: 300,
                    pixelOffset: new google.maps.Size(100, -20) 
                  });
                  infowindow.open(map);

            }


            // ============ INIT FIRE POSITION
            var fireCount = 4;
            for (var i = 0 ; i < fireCount ; i = i + 1 ) {
                var fire = new google.maps.Marker({
                    position: new google.maps.LatLng(gLat+getRnd(5), gLon+getRnd(5) ),
                    map: map,
                    icon: 'img/fire32.png'
                });
                console.log("push one fire") ;
                fireList.push(fire) ;
            }

            var droneCount = 15 ;
            for ( var d = 0 ; d < droneCount ; d = d + 1) {
                var drone = new google.maps.Marker({
                    position: new google.maps.LatLng(gLat+getRnd(5), gLon+getRnd(5) ),
                    map: map,
                    icon: 'img/blade32green2.png'
                });
                drone.posX = gLat+getRnd(30) ;
                drone.posY = gLon+getRnd(30) ;

                drone._id = "d" + d ;
                drone._numDeltas = 80 + getIntRnd(20) ;
                drone._delay = 30 + getIntRnd(30); //milliseconds
                drone._cnt = 0 ;
                drone._deltaLat = 0.0 ;
                drone._deltaLng = 0.0 ;

                drone._startX = gLat+getRnd(1) ;
                drone._startY = gLon+getRnd(1) ;
                drone._endX = gLat+getRnd(100) ;
                drone._endY = gLon+getRnd(100) ;
                drone._dir = 1 ;

                console.log("push one drone") ;
                droneList.push(drone) ;
                //transitionV2(drone, [gLat+getRnd(200), gLon+getRnd(200)]);

                droneList[ droneList.length -1 ].addListener('click',function(target){
                    console.log(target) ;
                    console.log("get done id=" + target ) ;
                    displayVideo() ;
                });
            }

            var gCenter = new google.maps.LatLng(24.930000, 121.280000) ;

            // // Create markers.
            // features.forEach(function (feature) {
            //     var marker = new google.maps.Marker({
            //         position: feature.position,
            //         icon: icons[feature.type].icon,
            //         map: map
            //     });
            // });


            var numDeltas = 20;
            var delay = 100 + Math.random(40) ; //milliseconds
            var i = 0;
            var deltaLat;
            var deltaLng;

            function transitionV2(drone, result){
                drone._cnt = 0;
                //drone.posX = result[0] ;
                //drone.posY = result[1] ;
                drone._deltaLat = (result[0] - drone.posX)/drone._numDeltas;
                drone._deltaLng = (result[1] - drone.posY)/drone._numDeltas;
                moveMarkerV2(drone);
            }

            function moveMarkerV2(drone){
                drone.posX += drone._deltaLat;
                drone.posY += drone._deltaLng;

                var latlng = new google.maps.LatLng(drone.posX, drone.posY);
                drone.setPosition(latlng);

                //console.log( drone._id + " cnt=" +  drone._cnt)
                if(drone._cnt != drone._numDeltas){
                    drone._cnt++ ;
                    setTimeout(function(){
                        moveMarkerV2(drone) ;
                    }, drone._delay);
                }
                else {
                    //console.log("change dir!! cnt=" + drone._cnt + "," + drone.posX + "/" + drone.posY) ;

                    drone._cnt = 0 ;
                    drone._deltaLat = 0.0 ;
                    drone._deltaLng = 0.0 ;
                    if ( drone._dir == 1 ) {
                        drone._dir = 2 ;
                        drone.posX = drone._endX ;
                        drone.posY = drone._endY ;
                        transitionV2(drone, [drone._startX, drone._startY]) ;    
                        drone.setIcon('img/blade32green2.png') ;
                    } else if (drone._dir == 2) {
                        drone._dir = 1
                        drone.posX = drone._startX ;
                        drone.posY = drone._startY ;
                        transitionV2(drone, [drone._endX, drone._endY]) ; 
                        drone.setIcon('img/blade32coffee.png') ;
                    }
                    else if ( drone_dir == 3 ) {

                    }
                    console.log("drone END!!") ;
                }
            }


            // ==========================


            var legend = document.getElementById('legend');
            map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(legend);


            var marker = new google.maps.Marker({
                position: latlng,
                map: map,
                icon: 'img/blade48blue.png',
                title: "State: AirDrop<BR>Power: 50%<BR>Owner: Harry Poter"
            });

            function transition(result){
                i = 0;
                deltaLat = (result[0] - position[0])/numDeltas;
                deltaLng = (result[1] - position[1])/numDeltas;
                moveMarker();
            }


            function moveMarker(){
                position[0] += deltaLat;
                position[1] += deltaLng;
                var latlng = new google.maps.LatLng(position[0], position[1]);
                marker.setTitle("Latitude:"+position[0]+" | Longitude:"+position[1]);
                marker.setPosition(latlng);
                if(i!=numDeltas){
                    i++;
                    setTimeout(moveMarker, delay);
                }
            }

            google.maps.event.addListener(map, 'click', function(event) {
                var result = [event.latLng.lat(), event.latLng.lng()];
                transition(result);
            });

            for (var d = 0 ; d < droneList.length ; d=d+1) {
                var drone = droneList[d] ;
                transitionV2(drone, [drone._endX, drone._endY]) ; 
            }


        }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkI0UQK6hLzN3w4NKI7PAmgUR9TMKD9C0&callback=initMap"></script>




    <script src="main.js">
    </script>
    <script>
        console.log("aa") ;
    </script>
</body>
</html>